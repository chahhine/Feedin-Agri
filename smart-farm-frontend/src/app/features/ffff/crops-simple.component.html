<div class="crops-simple-container">
  @if (isLoading()) {
    <div class="loading-overlay">
      <mat-spinner diameter="50"></mat-spinner>
      <p class="loading-text">{{ 'crops.dashboard.loading' | translate }}</p>
    </div>
  }

  @else if (error()) {
    <div class="error-container">
      <mat-icon>error_outline</mat-icon>
      <h2>{{ 'crops.dashboard.error' | translate }}</h2>
      <p>{{ error() }}</p>
      <button mat-raised-button color="primary" (click)="retry()">
        {{ 'errors.tryAgain' | translate }}
      </button>
    </div>
  }

  @else {
    <!-- Crop Selector Section -->
    <div class="crop-selector-section">
      <h1 class="page-title">
        <mat-icon>agriculture</mat-icon>
        {{ 'crops.dashboard.header' | translate }}
      </h1>

      @if (crops().length === 0) {
        <div class="empty-state">
          <mat-icon>agriculture</mat-icon>
          <h2>{{ 'crops.noCrops' | translate }}</h2>
          <p>{{ 'crops.dashboard.selectCropDescription' | translate }}</p>
        </div>
      } @else {
        <mat-form-field appearance="outline" class="crop-select-field">
          <mat-label>{{ 'crops.dashboard.selectCrop' | translate }}</mat-label>
          <mat-select 
            [value]="selectedCropId()"
            (selectionChange)="onCropSelected($event.value)">
            @for (crop of crops(); track crop.crop_id) {
              <mat-option [value]="crop.crop_id">
                {{ crop.name }} - {{ crop.variety || 'Standard' }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>

        <div class="crop-summary">
          <p><strong>{{ 'common.status' | translate }}:</strong> {{ crops().length }} {{ 'crops.title' | translate }}</p>
        </div>
      }
    </div>

    <!-- Selected Crop Details -->
    @if (selectedCrop()) {
      <div class="crop-details-card">
        <h2>{{ 'crops.dashboard.cropDetails' | translate }}</h2>
        
        <div class="details-grid">
          <div class="detail-item">
            <span class="detail-label">{{ 'crops.details.name' | translate }}</span>
            <span class="detail-value">{{ selectedCrop()!.name }}</span>
          </div>

          <div class="detail-item">
            <span class="detail-label">{{ 'crops.details.variety' | translate }}</span>
            <span class="detail-value">{{ selectedCrop()!.variety || 'Standard' }}</span>
          </div>

          <div class="detail-item">
            <span class="detail-label">{{ 'crops.details.status' | translate }}</span>
            <span class="detail-value status-badge" [class]="'status-' + selectedCrop()!.status">
              {{ selectedCrop()!.status | titlecase }}
            </span>
          </div>

          @if (selectedCrop()!.planting_date) {
            <div class="detail-item">
              <span class="detail-label">{{ 'crops.details.plantingDate' | translate }}</span>
              <span class="detail-value">{{ selectedCrop()!.planting_date | date: 'mediumDate' }}</span>
            </div>
          }

          @if (selectedCrop()!.expected_harvest_date) {
            <div class="detail-item">
              <span class="detail-label">{{ 'crops.details.expectedHarvest' | translate }}</span>
              <span class="detail-value">{{ selectedCrop()!.expected_harvest_date | date: 'mediumDate' }}</span>
            </div>
          }
        </div>

        @if (selectedCrop()!.description) {
          <div class="description-section">
            <h3>{{ 'common.details' | translate }}</h3>
            <p>{{ selectedCrop()!.description }}</p>
          </div>
        }
      </div>

      <!-- KPIs Section -->
      @if (featureFlags.kpis) {
        <div class="kpis-section">
          <h2>{{ 'crops.kpis.healthScore' | translate }}</h2>

          @if (loadingKpis()) {
            <div class="skeleton-kpis">
              <div class="skeleton-card"></div>
              <div class="skeleton-card"></div>
              <div class="skeleton-card"></div>
              <div class="skeleton-card"></div>
            </div>
          } @else if (kpisError()) {
            <p class="error-text">{{ kpisError() }}</p>
          } @else if (kpis()) {
            <div class="kpis-grid">
              <div class="kpi-card">
                <span class="kpi-label">{{ 'crops.kpis.yield' | translate }}</span>
                <span class="kpi-value">{{ kpis()!.yield }} {{ kpis()!.yieldUnit }}</span>
              </div>
              <div class="kpi-card">
                <span class="kpi-label">{{ 'crops.kpis.growthStage' | translate }}</span>
                <span class="kpi-value">{{ kpis()!.growthStage }}</span>
              </div>
              <div class="kpi-card">
                <span class="kpi-label">{{ 'crops.kpis.irrigationStatus' | translate }}</span>
                <span class="kpi-value">{{ kpis()!.irrigationStatus }}</span>
              </div>
              <div class="kpi-card">
                <span class="kpi-label">{{ 'crops.kpis.healthScore' | translate }}</span>
                <span class="kpi-value">{{ kpis()!.healthScore }}%</span>
              </div>
            </div>
          }
        </div>
      }

      <!-- Sensors Summary -->
      @if (featureFlags.sensorsSummary) {
        <div class="sensors-section">
          <h2>{{ 'sensors.title' | translate }}</h2>
          
          @if (loadingSensors()) {
            <div class="skeleton-sensors">
              <div class="skeleton-line"></div>
            </div>
          } @else if (sensorsError()) {
            <p class="error-text">{{ sensorsError() }}</p>
          } @else {
            <p><strong>{{ 'common.status' | translate }}:</strong> {{ sensorsCount() }} {{ 'sensors.title' | translate }}</p>
          }
        </div>
      }

      <!-- Analytics Section (Future) -->
      @if (featureFlags.analytics) {
        <div class="analytics-section">
          <h2>{{ 'crops.analytics.title' | translate }}</h2>
          <p class="coming-soon">{{ 'crops.analytics.loading' | translate }}</p>
        </div>
      }
    } @else {
      <div class="no-selection-state">
        <mat-icon>agriculture</mat-icon>
        <h2>{{ 'crops.dashboard.noCropSelected' | translate }}</h2>
        <p>{{ 'crops.dashboard.selectCropDescription' | translate }}</p>
      </div>
    }
  }
</div>


<div class="crop-dashboard">
  <!-- Loading State -->
  <div *ngIf="loading()" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading crop dashboard...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error() && !loading()" class="error-container">
    <mat-icon color="warn">error_outline</mat-icon>
    <h3>{{ error() }}</h3>
    <button mat-raised-button color="primary" (click)="refreshDashboard()">
      <mat-icon>refresh</mat-icon>
      Try Again
    </button>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading() && !error() && !hasCrops()" class="empty-state">
    <mat-icon>agriculture</mat-icon>
    <h2>No Crops Found</h2>
    <p>Start by creating your first crop to monitor its health and growth.</p>
    <button mat-raised-button color="primary" routerLink="/crops/create">
      <mat-icon>add</mat-icon>
      Create Crop
    </button>
  </div>

  <!-- Main Dashboard Content -->
  <div *ngIf="!loading() && !error() && dashboardData()" class="dashboard-content">

    <!-- Header: Crop Selector + Quick Actions -->
    <header class="dashboard-header">
      <div class="header-left">
        <mat-form-field appearance="outline" class="crop-selector">
          <mat-label>Select Crop</mat-label>
          <mat-select
            [value]="selectedCropId()"
            (selectionChange)="onCropChange($event.value)">
            <mat-option *ngFor="let crop of crops()" [value]="crop.crop_id">
              {{ crop.name }}
              <span class="crop-variety" *ngIf="crop.variety">({{ crop.variety }})</span>
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div class="crop-info">
          <h1>{{ dashboardData()?.crop.name }}</h1>
          <span class="crop-status" [class]="dashboardData()?.crop.status">
            {{ dashboardData()?.crop.status }}
          </span>
        </div>
      </div>

      <div class="header-actions">
        <button mat-icon-button (click)="refreshDashboard()" matTooltip="Refresh Data">
          <mat-icon>refresh</mat-icon>
        </button>
        <button mat-icon-button (click)="editCrop()" matTooltip="Edit Crop">
          <mat-icon>edit</mat-icon>
        </button>
        <button mat-stroked-button color="primary" routerLink="/crops">
          <mat-icon>view_list</mat-icon>
          All Crops
        </button>
      </div>
    </header>

    <!-- KPI Header Component -->
    <app-crop-kpi-header
      [kpis]="dashboardData()!.kpis"
      [healthStatus]="dashboardData()!.healthStatus"
      [activeFilter]="activeKPIFilter()"
      (filterChange)="onKPIFilterChange($event)">
    </app-crop-kpi-header>

    <!-- Main Grid: Health Analytics + Sidebar -->
    <section class="main-grid">
      <div class="health-panel">
        <app-crop-health-analytics
          [cropId]="selectedCropId()!"
          [sensors]="dashboardData()!.sensors">
        </app-crop-health-analytics>
      </div>

      <aside class="details-sidebar">
        <mat-card>
          <mat-card-header>
            <mat-card-title>Crop Details</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="detail-item">
              <span class="label">Variety:</span>
              <span class="value">{{ dashboardData()?.crop.variety || 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Planted:</span>
              <span class="value">
                {{ dashboardData()?.crop.planting_date ? (dashboardData()?.crop.planting_date | date:'mediumDate') : 'N/A' }}
              </span>
            </div>
            <div class="detail-item">
              <span class="label">Expected Harvest:</span>
              <span class="value">
                {{ dashboardData()?.crop.expected_harvest_date ? (dashboardData()?.crop.expected_harvest_date | date:'mediumDate') : 'N/A' }}
              </span>
            </div>
            <div class="detail-item">
              <span class="label">Status:</span>
              <span class="value status-badge" [class]="dashboardData()?.crop.status">
                {{ dashboardData()?.crop.status }}
              </span>
            </div>
            <div class="detail-item full-width" *ngIf="dashboardData()?.crop.description">
              <span class="label">Description:</span>
              <p class="description">{{ dashboardData()?.crop.description }}</p>
            </div>
            <div class="detail-item full-width" *ngIf="dashboardData()?.crop.notes">
              <span class="label">Notes:</span>
              <p class="notes">{{ dashboardData()?.crop.notes }}</p>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Sensors List -->
        <mat-card class="sensors-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>sensors</mat-icon>
              Connected Sensors
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div *ngIf="dashboardData()?.sensors.length === 0" class="no-sensors">
              <mat-icon>info_outline</mat-icon>
              <p>No sensors connected to this crop</p>
            </div>
            <div class="sensor-list" *ngIf="dashboardData()?.sensors.length">
              <div *ngFor="let sensor of dashboardData()?.sensors" class="sensor-item">
                <mat-icon class="sensor-icon">{{ sensor.type.includes('temp') ? 'thermostat' : 'sensors' }}</mat-icon>
                <div class="sensor-info">
                  <span class="sensor-type">{{ sensor.type }}</span>
                  <span class="sensor-location">{{ sensor.location || 'No location' }}</span>
                </div>
                <span class="sensor-unit">{{ sensor.unit }}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </aside>
    </section>

    <!-- Smart Actions Section -->
    <section class="actions-section">
      <app-crop-smart-actions
        [cropId]="selectedCropId()!"
        [sensors]="dashboardData()!.sensors">
      </app-crop-smart-actions>
    </section>

    <!-- Events Timeline Section -->
    <section class="events-section">
      <app-crop-events-timeline
        [cropId]="selectedCropId()!"
        [sensors]="dashboardData()!.sensors">
      </app-crop-events-timeline>
    </section>
  </div>
</div>

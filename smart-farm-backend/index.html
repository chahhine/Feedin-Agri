<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Register New Sensor</title>
<style>
    body {
        font-family: 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0;
        padding: 20px;
        min-height: 100vh;
    }
    .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .header {
        text-align: center;
        margin-bottom: 30px;
    }
    h2 {
        color: #333;
        font-size: 2.2em;
        margin: 0;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .subtitle {
        color: #666;
        margin-top: 8px;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    .form-group {
        display: flex;
        flex-direction: column;
    }
    .form-group.full-width {
        grid-column: 1 / -1;
    }
    
    label {
        font-weight: 600;
        color: #555;
        margin-bottom: 8px;
        font-size: 14px;
    }
    .required::after {
        content: " *";
        color: #e74c3c;
    }
    
    input, select, textarea {
        padding: 12px 16px;
        border: 2px solid #e1e8ed;
        border-radius: 12px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: #fafbfc;
    }
    
    input:focus, select:focus, textarea:focus {
        border-color: #667eea;
        background: white;
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    textarea {
        min-height: 100px;
        font-family: 'Courier New', monospace;
        resize: vertical;
    }
    
    .threshold-section {
        background: #f8f9ff;
        padding: 20px;
        border-radius: 12px;
        border: 2px dashed #d1d9ff;
        margin: 20px 0;
    }
    .threshold-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }
    .threshold-title::before {
        content: "‚ö†Ô∏è";
        margin-right: 8px;
    }
    
    .action-section {
        background: #fff9f0;
        padding: 20px;
        border-radius: 12px;
        border: 2px dashed #ffd700;
        margin: 20px 0;
    }
    .action-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }
    .action-title::before {
        content: "ü§ñ";
        margin-right: 8px;
    }
    
    button {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 16px 32px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        margin-top: 30px;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    
    button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .error {
        color: #e74c3c;
        font-size: 12px;
        margin-top: 5px;
        font-weight: 500;
    }
    
    .success {
        color: #27ae60;
        font-size: 14px;
        margin-top: 15px;
        text-align: center;
        font-weight: 600;
        padding: 12px;
        background: #d5f5e3;
        border-radius: 8px;
        border: 1px solid #27ae60;
    }
    
    .info-box {
        background: #e8f4fd;
        border: 1px solid #3498db;
        border-radius: 8px;
        padding: 12px;
        margin: 10px 0;
        font-size: 13px;
        color: #2c3e50;
    }
    
    .sensor-type-info {
        display: none;
        margin-top: 10px;
        padding: 10px;
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 6px;
        font-size: 12px;
        color: #856404;
    }
    
    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
        .container {
            padding: 20px;
            margin: 10px;
        }
    }
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>üåæ Smart Farm Sensor Registration</h2>
        <p class="subtitle">Complete sensor setup and configuration</p>
    </div>
    
    <form id="sensorForm">
        <!-- Basic Information -->
        <div class="form-grid">
            <div class="form-group">
                <label for="farmId" class="required">Select Farm</label>
                <select id="farmId" name="farmId" required>
                    <option value="">-- Choose Farm --</option>
                </select>
                <div class="error" id="farmError"></div>
            </div>

            <div class="form-group">
                <label for="cropId">Select Crop (Optional)</label>
                <select id="cropId" name="cropId">
                    <option value="">-- No specific crop --</option>
                </select>
                <div class="error" id="cropError"></div>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label for="sensorId" class="required">Sensor Unique ID</label>
                <input type="text" id="sensorId" name="sensorId" placeholder="e.g., TEMP_001, DHT11_GH1" required maxlength="36">
                <div class="error" id="sensorIdError"></div>
            </div>

            <div class="form-group">
                <label for="deviceId" class="required">Device ID</label>
                <input type="text" id="deviceId" name="deviceId" placeholder="e.g., RPI001, ARDUINO_01" required maxlength="100">
                <div class="error" id="deviceError"></div>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label for="sensorType" class="required">Sensor Type</label>
                <select id="sensorType" name="sensorType" required>
                    <option value="">-- Select Sensor Type --</option>
                    <option value="temperature">Temperature</option>
                    <option value="humidity">Humidity</option>
                    <option value="soilMoisture">Soil Moisture</option>
                    <option value="soilTemperature">Soil Temperature</option>
                    <option value="light">Light Intensity</option>
                    <option value="ph">pH Level</option>
                    <option value="ec">Electrical Conductivity</option>
                    <option value="co2">CO2 Concentration</option>
                    <option value="pressure">Atmospheric Pressure</option>
                    <option value="windSpeed">Wind Speed</option>
                    <option value="rainfall">Rainfall</option>
                    <option value="uv">UV Index</option>
                    <option value="motion">Motion Detection</option>
                    <option value="door">Door/Window Status</option>
                    <option value="water">Water Level</option>
                    <option value="DHT11">DHT11 (Combo Sensor)</option>
                    <option value="DHT22">DHT22 (Combo Sensor)</option>
                </select>
                <div class="sensor-type-info" id="sensorTypeInfo"></div>
                <div class="error" id="typeError"></div>
            </div>

            <div class="form-group">
                <label for="unit" class="required">Measurement Unit</label>
                <input type="text" id="unit" name="unit" placeholder="e.g., ¬∞C, %, ppm, lux" required maxlength="20">
                <div class="error" id="unitError"></div>
            </div>
        </div>

        <div class="form-group full-width">
            <label for="location">Location Description</label>
            <input type="text" id="location" name="location" placeholder="e.g., Greenhouse A - Section 2, Field North Corner" maxlength="100">
            <div class="info-box">üí° Specify exact location within your farm for easy identification</div>
        </div>

        <!-- Threshold Configuration -->
        <div class="threshold-section">
            <div class="threshold-title">Alert Thresholds Configuration</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="minCritical">üî¥ Critical Minimum</label>
                    <input type="number" id="minCritical" name="minCritical" step="0.01" placeholder="e.g., 0">
                </div>
                
                <div class="form-group">
                    <label for="minWarning">üü° Warning Minimum</label>
                    <input type="number" id="minWarning" name="minWarning" step="0.01" placeholder="e.g., 10">
                </div>
                
                <div class="form-group">
                    <label for="maxWarning">üü° Warning Maximum</label>
                    <input type="number" id="maxWarning" name="maxWarning" step="0.01" placeholder="e.g., 35">
                </div>
                
                <div class="form-group">
                    <label for="maxCritical">üî¥ Critical Maximum</label>
                    <input type="number" id="maxCritical" name="maxCritical" step="0.01" placeholder="e.g., 45">
                </div>
            </div>
            <div class="info-box">
                ‚ö†Ô∏è Set thresholds for automatic alerts: Critical < Warning < Normal < Warning < Critical
            </div>
        </div>

        <!-- Action Configuration -->
        <div class="action-section">
            <div class="action-title">Automated Actions</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="actionLow">Action for Low Values</label>
                    <textarea id="actionLow" name="actionLow" placeholder="e.g., Turn on heater, Send alert to manager, Activate irrigation"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="actionHigh">Action for High Values</label>
                    <textarea id="actionHigh" name="actionHigh" placeholder="e.g., Turn on fan, Open windows, Send SMS alert"></textarea>
                </div>
            </div>
            <div class="info-box">
                ü§ñ Define what should happen when sensor values go beyond thresholds
            </div>
        </div>

        <button type="submit">üöÄ Register Sensor</button>
        <div class="success" id="successMessage" style="display: none;"></div>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
    const farmSelect = document.getElementById("farmId");
    const cropSelect = document.getElementById("cropId");
    const farmError = document.getElementById("farmError");
    const cropError = document.getElementById("cropError");

    // Load farms
    try {
        const res = await fetch("http://localhost:3000/farms");
        if (!res.ok) throw new Error("Failed to fetch farms");
        const farms = await res.json();
        
        console.log("Farms loaded:", farms);
        
        if (farms.length === 0) {
            farmError.textContent = "No farms found. Please create a farm first.";
            return;
        }
        
        farms.forEach(farm => {
            const opt = document.createElement("option");
            opt.value = farm.farm_id || farm.id || farm.farmId;
            opt.textContent = farm.name || farm.farm_name;
            farmSelect.appendChild(opt);
            
            console.log("Added farm option:", { value: opt.value, text: opt.textContent });
        });
    } catch (err) {
        console.error("Error loading farms:", err);
        farmError.textContent = "Error loading farms: " + err.message;
    }

    // Load crops
    try {
        const res = await fetch("http://localhost:3000/crops");
        if (res.ok) {
            const crops = await res.json();
            console.log("Crops loaded:", crops);
            
            crops.forEach(crop => {
                const opt = document.createElement("option");
                opt.value = crop.crop_id || crop.id || crop.cropId;
                opt.textContent = crop.name || crop.crop_name;
                cropSelect.appendChild(opt);
            });
        }
    } catch (err) {
        console.log("Crops endpoint not available or error:", err.message);
    }

    // Sensor type change handler
    document.getElementById("sensorType").addEventListener("change", (e) => {
        const infoDiv = document.getElementById("sensorTypeInfo");
        const unitField = document.getElementById("unit");
        
        infoDiv.style.display = "none";
        
        switch(e.target.value) {
            case "temperature":
                unitField.value = "¬∞C";
                break;
            case "humidity":
                unitField.value = "%";
                break;
            case "soilMoisture":
                unitField.value = "%";
                break;
            case "light":
                unitField.value = "lux";
                break;
            case "ph":
                unitField.value = "pH";
                break;
            case "ec":
                unitField.value = "¬µS/cm";
                break;
            case "co2":
                unitField.value = "ppm";
                break;
            case "pressure":
                unitField.value = "hPa";
                break;
            case "windSpeed":
                unitField.value = "m/s";
                break;
            case "rainfall":
                unitField.value = "mm";
                break;
            case "DHT11":
            case "DHT22":
                infoDiv.textContent = "‚ö†Ô∏è Combo sensor detected! You'll need to register this twice: once for temperature (¬∞C) and once for humidity (%).";
                infoDiv.style.display = "block";
                unitField.value = "¬∞C";
                break;
            case "motion":
            case "door":
                unitField.value = "boolean";
                break;
            case "water":
                unitField.value = "cm";
                break;
            case "uv":
                unitField.value = "index";
                break;
        }
    });
});

document.getElementById("sensorForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const successMessage = document.getElementById("successMessage");
    successMessage.style.display = "none";

    const payload = {
        sensor_id: document.getElementById("sensorId").value,
        farm_id: document.getElementById("farmId").value,
        type: document.getElementById("sensorType").value,
        unit: document.getElementById("unit").value,
        device_id: document.getElementById("deviceId").value,
        location: document.getElementById("location").value || null,
        crop_id: document.getElementById("cropId").value || null,
        min_critical: parseFloat(document.getElementById("minCritical").value) || null,
        min_warning: parseFloat(document.getElementById("minWarning").value) || null,
        max_warning: parseFloat(document.getElementById("maxWarning").value) || null,
        max_critical: parseFloat(document.getElementById("maxCritical").value) || null,
        action_low: document.getElementById("actionLow").value || null,
        action_high: document.getElementById("actionHigh").value || null
    };

    // Validation
    console.log("Form values:");
    console.log("- farmId element value:", document.getElementById("farmId").value);
    console.log("Payload being sent:", payload);
    
    if (!payload.farm_id || payload.farm_id === "undefined" || payload.farm_id === "") {
        alert("‚ùå Please select a valid farm");
        return;
    }

    // Validate thresholds
    if (payload.min_critical !== null && payload.min_warning !== null && payload.min_critical >= payload.min_warning) {
        alert("‚ùå Critical minimum must be less than warning minimum");
        return;
    }
    
    if (payload.max_warning !== null && payload.max_critical !== null && payload.max_warning >= payload.max_critical) {
        alert("‚ùå Warning maximum must be less than critical maximum");
        return;
    }

    const submitBtn = e.target.querySelector("button");
    submitBtn.disabled = true;
    submitBtn.textContent = "‚è≥ Registering Sensor...";

    try {
        const res = await fetch("http://localhost:3000/sensors", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            const result = await res.json();
            successMessage.textContent = "‚úÖ Sensor registered successfully! ID: " + payload.sensor_id;
            successMessage.style.display = "block";
            e.target.reset();
            
            // Reset unit field
            document.getElementById("unit").value = "";
            document.getElementById("sensorTypeInfo").style.display = "none";
            
        } else {
            const errData = await res.json();
            alert("‚ùå Error: " + (errData.message || "Unknown error"));
        }
    } catch (err) {
        alert("‚ùå Network error: " + err.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "üöÄ Register Sensor";
    }
});
</script>

</body>
</html>
# COMPLETE DATABASE TRANSFORMATION REPORT
## Railway PostgreSQL Schema Analysis & Required Changes

**Generated:** Full Database Scan Mode  
**Source:** `railway.sql` PostgreSQL backup  
**Target:** Current NestJS Backend + Angular Frontend

---

## 1. FULL DATABASE MAP

### 1.1 Database Enums

#### `action_status_enum`
- **Values:** `'queued'`, `'sent'`, `'ack'`, `'error'`, `'timeout'`, `'failed'`
- **Used by:** `action_logs.status`
- **Current Backend:** ‚úÖ Matches (string union type)

#### `user_role_enum`
- **Values:** `'admin'`, `'farmer'`, `'viewer'`
- **Used by:** `users.role`
- **Current Backend:** ‚ùå MISMATCH - Backend has `'moderator'` instead of `'viewer'`

#### `user_status_enum`
- **Values:** `'active'`, `'inactive'`, `'suspended'`
- **Used by:** `users.status`
- **Current Backend:** ‚úÖ Matches

---

### 1.2 Table: `users`

**Primary Key:** `user_id` (varchar(36))

**Columns:**
- `user_id` varchar(36) PRIMARY KEY
- `email` varchar(100) NOT NULL UNIQUE
- `password` varchar(255) NOT NULL
- `first_name` varchar(100) NOT NULL
- `last_name` varchar(100) NOT NULL
- `phone` varchar(20) NULLABLE
- `role` user_role_enum NOT NULL DEFAULT 'farmer'
- `status` user_status_enum NOT NULL DEFAULT 'active'
- `address` text NULLABLE
- `city` varchar(100) NULLABLE
- `country` varchar(100) NULLABLE
- `date_of_birth` date NULLABLE
- `gender` varchar(10) NULLABLE
- `profile_picture` text NULLABLE
- `last_login` timestamp NULLABLE
- `reset_token` varchar(255) NULLABLE
- `reset_token_expires` timestamp NULLABLE
- `created_at` timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP
- `updated_at` timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP

**Foreign Keys:** None (root table)

**Indexes:**
- PRIMARY KEY on `user_id`
- UNIQUE on `email`

**Relationships:**
- One-to-Many ‚Üí `farms` (via `farms.owner_id`)
- One-to-Many ‚Üí `notifications` (via `notifications.user_id`)

**Current Backend Entity:** `src/entities/user.entity.ts`
- ‚úÖ Structure matches
- ‚ùå Enum mismatch: Backend has `UserRole.MODERATOR`, DB has `'viewer'`

---

### 1.3 Table: `farms`

**Primary Key:** `farm_id` (varchar(36))

**Columns:**
- `farm_id` varchar(36) PRIMARY KEY
- `name` varchar(100) NOT NULL
- `location` text NULLABLE
- `owner_id` varchar(36) NULLABLE

**Foreign Keys:**
- `FK_farms_users` ‚Üí `users.user_id` (via `owner_id`)

**Indexes:**
- PRIMARY KEY on `farm_id`
- Foreign key index on `owner_id`

**Relationships:**
- Many-to-One ‚Üí `users` (via `owner_id`)
- One-to-Many ‚Üí `devices` (via `devices.farm_id`)
- One-to-Many ‚Üí `sensors` (via `sensors.farm_id`)

**Current Backend Entity:** `src/modules/farms/farm.entity.ts`
- ‚ùå **MISSING COLUMNS:** `latitude`, `longitude`, `created_at`, `updated_at` in DB
- ‚úÖ Backend has `latitude`, `longitude`, `created_at`, `updated_at` but DB doesn't

---

### 1.4 Table: `devices`

**Primary Key:** `device_id` (varchar(100))

**Columns:**
- `device_id` varchar(100) PRIMARY KEY
- `name` varchar(255) NOT NULL
- `location` varchar(255) NOT NULL
- `status` varchar(255) NOT NULL
- `farm_id` varchar(36) NOT NULL

**Foreign Keys:**
- `FK_devices_farms` ‚Üí `farms.farm_id` (via `farm_id`)

**Indexes:**
- PRIMARY KEY on `device_id`
- Foreign key index on `farm_id`

**Relationships:**
- Many-to-One ‚Üí `farms` (via `farm_id`)
- One-to-Many ‚Üí `sensors` (via `sensors.device_id`)

**Current Backend Entity:** `src/entities/device.entity.ts`
- ‚ùå **MISSING COLUMNS:** `created_at`, `updated_at` in DB
- ‚úÖ Backend has `created_at`, `updated_at` but DB doesn't

---

### 1.5 Table: `sensors`

**Primary Key:** `id` (integer, auto-increment)

**Columns:**
- `id` integer PRIMARY KEY (GENERATED BY DEFAULT AS IDENTITY)
- `sensor_id` varchar(36) NOT NULL
- `farm_id` varchar(100) NOT NULL
- `type` varchar(50) NOT NULL
- `unit` varchar(20) NOT NULL
- `device_id` varchar(100) NOT NULL
- `location` varchar(100) NULLABLE
- `crop_id` varchar(36) NULLABLE
- `min_critical` numeric(10,2) NULLABLE
- `min_warning` numeric(10,2) NULLABLE
- `max_warning` numeric(10,2) NULLABLE
- `max_critical` numeric(10,2) NULLABLE
- `action_low` text NULLABLE
- `action_high` text NULLABLE

**Foreign Keys:**
- `FK_sensors_farms` ‚Üí `farms.farm_id` (via `farm_id`)
- `FK_sensors_crops` ‚Üí `crops.crop_id` (via `crop_id`)
- `FK_sensors_devices` ‚Üí `devices.device_id` (via `device_id`)

**Indexes:**
- PRIMARY KEY on `id`
- `IDX_sensors_farm_id` on `farm_id`
- `IDX_sensors_crop_id` on `crop_id`
- `IDX_sensors_device_id` on `device_id`

**Relationships:**
- Many-to-One ‚Üí `farms` (via `farm_id`)
- Many-to-One ‚Üí `crops` (via `crop_id`)
- Many-to-One ‚Üí `devices` (via `device_id`)
- One-to-Many ‚Üí `sensor_readings` (via `sensor_readings.sensor_id`)

**Current Backend Entity:** `src/entities/sensor.entity.ts`
- ‚ùå **MISSING COLUMNS:** `created_at`, `updated_at` in DB
- ‚úÖ Backend has `created_at`, `updated_at` but DB doesn't
- ‚ö†Ô∏è **TYPE MISMATCH:** Backend has `crop_id` as `uuid`, DB has `varchar(36)`

---

### 1.6 Table: `sensor_readings`

**Primary Key:** `id` (integer, auto-increment)

**Columns:**
- `id` integer PRIMARY KEY (GENERATED BY DEFAULT AS IDENTITY)
- `sensor_id` varchar(36) NOT NULL
- `value1` double precision NULLABLE
- `value2` double precision NULLABLE
- `createdAt` timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP

**Foreign Keys:** None (soft reference to `sensors.sensor_id`)

**Indexes:**
- PRIMARY KEY on `id`
- `IDX_sensor_readings_sensor_id` on `sensor_id`

**Relationships:**
- Many-to-One ‚Üí `sensors` (via `sensor_id` - no FK constraint, but logical relationship)

**Current Backend Entity:** `src/entities/sensor-reading.entity.ts`
- ‚ùå **COLUMN NAME MISMATCH:** DB has `createdAt` (camelCase), Backend expects `created_at` (snake_case)
- ‚ö†Ô∏è **PRIMARY KEY:** Backend uses `@PrimaryGeneratedColumn()` which matches DB `id` integer

---

### 1.7 Table: `crops`

**Primary Key:** `crop_id` (varchar(36))

**Columns:**
- `crop_id` varchar(36) PRIMARY KEY
- `name` varchar(100) NOT NULL
- `description` text NULLABLE
- `variety` varchar(100) NULLABLE
- `planting_date` date NULLABLE
- `expected_harvest_date` date NULLABLE
- `status` varchar(50) NOT NULL DEFAULT 'planted'
- `notes` text NULLABLE
- `created_at` timestamp with time zone NOT NULL DEFAULT now()
- `updated_at` timestamp with time zone NOT NULL DEFAULT now()

**Constraints:**
- CHECK constraint: `status` must be one of: `'planted'`, `'growing'`, `'harvested'`, `'failed'`

**Foreign Keys:** None (root table)

**Indexes:**
- PRIMARY KEY on `crop_id`

**Relationships:**
- One-to-Many ‚Üí `sensors` (via `sensors.crop_id`)

**Current Backend Entity:** `src/entities/crop.entity.ts`
- ‚úÖ Structure matches
- ‚ö†Ô∏è **PRIMARY KEY TYPE:** Backend uses `@PrimaryGeneratedColumn('uuid')`, DB uses `varchar(36)` (not auto-generated)

---

### 1.8 Table: `action_logs`

**Primary Key:** `id` (integer, auto-increment)

**Columns:**
- `id` integer PRIMARY KEY (GENERATED BY DEFAULT AS IDENTITY)
- `created_at` timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP
- `updated_at` timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP
- `trigger_source` varchar(10) NOT NULL
- `device_id` varchar(100) NOT NULL
- `sensor_id` varchar(100) NULLABLE
- `sensor_type` varchar(50) NULLABLE
- `value` double precision NULLABLE
- `unit` varchar(20) NULLABLE
- `violation_type` varchar(30) NULLABLE
- `action_uri` varchar(255) NOT NULL
- `status` action_status_enum NOT NULL
- `topic` varchar(255) NULLABLE
- `error_message` text NULLABLE
- `payload` jsonb NULLABLE
- `action_id` varchar(100) NULLABLE
- `action_type` varchar(20) NULLABLE
- `qos_level` integer NULLABLE
- `retain_flag` boolean NULLABLE
- `sent_at` timestamp NULLABLE
- `ack_at` timestamp NULLABLE
- `timeout_at` timestamp NULLABLE
- `failed_at` timestamp NULLABLE
- `retry_count` integer NOT NULL DEFAULT 0
- `max_retries` integer NOT NULL DEFAULT 1

**Foreign Keys:** None (soft references to `devices.device_id` and `sensors.sensor_id`)

**Indexes:**
- PRIMARY KEY on `id`
- `IDX_action_logs_action_id` on `action_id`
- `IDX_action_logs_device` on `device_id`
- `IDX_action_logs_sensor` on `sensor_id`

**Relationships:**
- Many-to-One ‚Üí `devices` (via `device_id` - no FK constraint)
- Many-to-One ‚Üí `sensors` (via `sensor_id` - no FK constraint)

**Current Backend Entity:** `src/entities/action-log.entity.ts`
- ‚úÖ Structure matches
- ‚ö†Ô∏è **PRIMARY KEY:** Backend uses `@PrimaryGeneratedColumn()`, DB uses integer sequence

---

### 1.9 Table: `notifications`

**Primary Key:** `id` (uuid, auto-generated)

**Columns:**
- `id` uuid PRIMARY KEY DEFAULT gen_random_uuid()
- `user_id` varchar(36) NOT NULL
- `level` varchar(10) NOT NULL
- `source` varchar(20) NOT NULL
- `title` varchar(200) NOT NULL
- `message` text NULLABLE
- `context` jsonb NULLABLE
- `is_read` boolean NOT NULL DEFAULT false
- `created_at` timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP
- `updated_at` timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP

**Foreign Keys:**
- `fk_notifications_user` ‚Üí `users.user_id` (via `user_id`) ON DELETE CASCADE

**Indexes:**
- PRIMARY KEY on `id`
- `idx_notifications_user_read_created` on (`user_id`, `is_read`, `created_at`)
- `idx_notifications_created` on `created_at`

**Relationships:**
- Many-to-One ‚Üí `users` (via `user_id`)

**Current Backend Entity:** `src/entities/notification.entity.ts`
- ‚úÖ Structure matches
- ‚úÖ UUID generation matches

---

### 1.10 Table: `sensor_actuator_rules`

**Primary Key:** `id` (integer, auto-increment)

**Columns:**
- `id` integer PRIMARY KEY (GENERATED BY DEFAULT AS IDENTITY)
- `rule_name` varchar(100) NOT NULL
- `sensor_type` varchar(50) NULLABLE
- `sensor_location` varchar(100) NULLABLE
- `farm_id` varchar(100) NULLABLE
- `device_id` varchar(100) NULLABLE
- `violation_type` varchar(30) NOT NULL
- `actuator_command` varchar(50) NOT NULL
- `target_device_id` varchar(100) NULLABLE
- `priority` integer NOT NULL DEFAULT 0
- `enabled` boolean NOT NULL DEFAULT true
- `description` text NULLABLE
- `created_at` timestamp NOT NULL DEFAULT now()
- `updated_at` timestamp NOT NULL DEFAULT now()

**Foreign Keys:** None (soft references to `farms.farm_id` and `devices.device_id`)

**Indexes:**
- PRIMARY KEY on `id`
- `idx_enabled` on `enabled`
- `idx_farm_id` on `farm_id`
- `idx_priority` on `priority`
- `idx_rules_enabled` on `enabled`
- `idx_rules_farm_id` on `farm_id`
- `idx_rules_priority` on `priority`
- `idx_rules_sensor_type_violation` on (`sensor_type`, `violation_type`)
- `idx_sensor_type_violation` on (`sensor_type`, `violation_type`)

**Relationships:**
- Many-to-One ‚Üí `farms` (via `farm_id` - no FK constraint)
- Many-to-One ‚Üí `devices` (via `device_id` - no FK constraint)

**Current Backend Entity:** `src/entities/sensor-actuator-rule.entity.ts`
- ‚úÖ Structure matches

---

### 1.11 Visual Database Relationship Map

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    users    ‚îÇ
‚îÇ  (PK: id)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 1:N
       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     farms       ‚îÇ         ‚îÇ    crops     ‚îÇ
‚îÇ  (PK: farm_id)  ‚îÇ         ‚îÇ (PK: crop_id)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                           ‚îÇ
       ‚îÇ 1:N                       ‚îÇ 1:N
       ‚îÇ                           ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    devices      ‚îÇ         ‚îÇ    sensors      ‚îÇ
‚îÇ (PK: device_id) ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  (PK: id)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    N:1  ‚îÇ  (FK: device_id)‚îÇ
                            ‚îÇ  (FK: farm_id)  ‚îÇ
                            ‚îÇ  (FK: crop_id)   ‚îÇ
                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                   ‚îÇ
                                   ‚îÇ 1:N
                                   ‚îÇ
                            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                            ‚îÇ  sensor_readings    ‚îÇ
                            ‚îÇ   (PK: id)          ‚îÇ
                            ‚îÇ   (FK: sensor_id)   ‚îÇ
                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    users    ‚îÇ
‚îÇ  (PK: id)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 1:N
       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   notifications     ‚îÇ
‚îÇ   (PK: id, uuid)    ‚îÇ
‚îÇ   (FK: user_id)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  action_logs        ‚îÇ
‚îÇ  (PK: id)           ‚îÇ
‚îÇ  (soft FK: device_id)‚îÇ
‚îÇ  (soft FK: sensor_id)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇsensor_actuator_rules ‚îÇ
‚îÇ  (PK: id)           ‚îÇ
‚îÇ  (soft FK: farm_id) ‚îÇ
‚îÇ  (soft FK: device_id)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 2. REAL INTERPRETATION OF DATA MODEL

### 2.1 Core Entities Mapping

#### **Devices**
- **Table:** `devices`
- **Purpose:** Physical IoT devices deployed on farms
- **Key Fields:** `device_id` (unique identifier), `name`, `location`, `status`, `farm_id`
- **Relationships:** Belongs to one `farm`, has many `sensors`

#### **Sensors**
- **Table:** `sensors`
- **Purpose:** Individual sensors attached to devices (temperature, humidity, light, etc.)
- **Key Fields:** `id` (auto-increment PK), `sensor_id` (logical identifier), `type`, `unit`, `device_id`, `farm_id`, `crop_id`
- **Relationships:** Belongs to one `device`, one `farm`, optionally one `crop`
- **Threshold Fields:** `min_critical`, `min_warning`, `max_warning`, `max_critical`
- **Action Fields:** `action_low`, `action_high` (MQTT action URIs)

#### **Actuators**
- **Table:** None (actuators are represented as actions in `action_logs` and rules in `sensor_actuator_rules`)
- **Purpose:** Actuators are controlled via MQTT commands, not stored as separate entities
- **Implementation:** Commands stored in `sensor_actuator_rules.actuator_command` and executed via `action_logs.action_uri`

#### **Sensor Readings**
- **Table:** `sensor_readings`
- **Purpose:** Time-series data from sensors
- **Key Fields:** `id` (auto-increment PK), `sensor_id`, `value1`, `value2`, `createdAt`
- **Relationships:** Belongs to one `sensor` (via `sensor_id`)

#### **Automation Rules**
- **Table:** `sensor_actuator_rules`
- **Purpose:** Dynamic rules mapping sensor violations to actuator actions
- **Key Fields:** `rule_name`, `sensor_type`, `violation_type`, `actuator_command`, `priority`, `enabled`
- **Wildcard Support:** NULL values in `sensor_type`, `farm_id`, `device_id` act as wildcards

#### **Farms**
- **Table:** `farms`
- **Purpose:** Farm locations owned by users
- **Key Fields:** `farm_id`, `name`, `location`, `owner_id`
- **Relationships:** Belongs to one `user` (owner), has many `devices` and `sensors`

#### **Farmers/Users**
- **Table:** `users`
- **Purpose:** System users (farmers, admins, viewers)
- **Key Fields:** `user_id`, `email`, `role`, `status`
- **Relationships:** Owns many `farms`, receives many `notifications`

#### **Crops**
- **Table:** `crops`
- **Purpose:** Crop types and their lifecycle information
- **Key Fields:** `crop_id`, `name`, `variety`, `status`, `planting_date`, `expected_harvest_date`
- **Relationships:** Has many `sensors` (sensors can be associated with specific crops)

#### **Action Logs**
- **Table:** `action_logs`
- **Purpose:** Audit trail of all actuator actions (automatic and manual)
- **Key Fields:** `id`, `device_id`, `sensor_id`, `action_uri`, `status`, `trigger_source`
- **Status Tracking:** Tracks action lifecycle (queued ‚Üí sent ‚Üí ack/error/timeout/failed)

---

### 2.2 Architecture Inference

**IoT Device Hierarchy:**
```
Farm
  ‚îî‚îÄ‚îÄ Device (e.g., "DHT11 Sensor Hub")
      ‚îî‚îÄ‚îÄ Sensors (e.g., "temperature", "humidity")
          ‚îî‚îÄ‚îÄ Sensor Readings (time-series data)
```

**Automation Flow:**
```
Sensor Reading ‚Üí Threshold Check ‚Üí Violation Detected
  ‚Üí sensor_actuator_rules lookup ‚Üí Action Executed
  ‚Üí action_logs entry created ‚Üí MQTT command sent
  ‚Üí Device acknowledges ‚Üí action_logs.status updated
```

**User Access Model:**
```
User (owner) ‚Üí Farms ‚Üí Devices ‚Üí Sensors ‚Üí Readings
User ‚Üí Notifications (alerts, system messages)
```

---

## 3. IDENTIFY ALL REQUIRED APP CHANGES

### 3.1 Backend Entity Changes

#### **3.1.1 User Entity** (`src/entities/user.entity.ts`)

**Issue:** Enum mismatch - Backend has `UserRole.MODERATOR`, Database has `'viewer'`

**Required Change:**
- **File:** `src/entities/user.entity.ts`
- **Line:** 9
- **Change:** Replace `MODERATOR = 'moderator'` with `VIEWER = 'viewer'`
- **Reason:** Database enum `user_role_enum` only has `'admin'`, `'farmer'`, `'viewer'`
- **Impact:** Any code referencing `UserRole.MODERATOR` will break

**Code Location:**
```typescript
// CURRENT (WRONG):
export enum UserRole {
  ADMIN = 'admin',
  FARMER = 'farmer',
  MODERATOR = 'moderator'  // ‚ùå Doesn't exist in DB
}

// REQUIRED:
export enum UserRole {
  ADMIN = 'admin',
  FARMER = 'farmer',
  VIEWER = 'viewer'  // ‚úÖ Matches DB
}
```

---

#### **3.1.2 Farm Entity** (`src/modules/farms/farm.entity.ts`)

**Issue:** Database doesn't have `latitude`, `longitude`, `created_at`, `updated_at` columns

**Required Change:**
- **File:** `src/modules/farms/farm.entity.ts`
- **Lines:** 17-30
- **Change:** Remove or make nullable `latitude`, `longitude`, `created_at`, `updated_at` columns
- **Reason:** Database schema only has: `farm_id`, `name`, `location`, `owner_id`
- **Impact:** Any code reading/writing these fields will fail

**Code Location:**
```typescript
// CURRENT (WRONG):
@Column({ type: 'decimal', precision: 10, scale: 8, nullable: true })
latitude: number;  // ‚ùå Not in DB

@Column({ type: 'decimal', precision: 11, scale: 8, nullable: true })
longitude: number;  // ‚ùå Not in DB

@CreateDateColumn({ type: 'timestamp', precision: 6 })
created_at: Date;  // ‚ùå Not in DB

@UpdateDateColumn({ type: 'timestamp', precision: 6 })
updated_at: Date;  // ‚ùå Not in DB

// REQUIRED:
// Remove these columns entirely or mark as @Column({ select: false }) to ignore
```

**Alternative:** If these fields are needed, they must be added to the database schema first.

---

#### **3.1.3 Device Entity** (`src/entities/device.entity.ts`)

**Issue:** Database doesn't have `created_at`, `updated_at` columns

**Required Change:**
- **File:** `src/entities/device.entity.ts`
- **Lines:** 21-25
- **Change:** Remove `created_at`, `updated_at` columns or mark as ignored
- **Reason:** Database schema only has: `device_id`, `name`, `location`, `status`, `farm_id`
- **Impact:** Any code reading/writing these fields will fail

**Code Location:**
```typescript
// CURRENT (WRONG):
@CreateDateColumn({ type: 'timestamp', precision: 6 })
created_at: Date;  // ‚ùå Not in DB

@UpdateDateColumn({ type: 'timestamp', precision: 6 })
updated_at: Date;  // ‚ùå Not in DB

// REQUIRED:
// Remove these columns or use @Column({ select: false }) to ignore
```

**Note:** Service code already has commented-out references to `created_at` (lines 50, 103, 111), indicating awareness of this issue.

---

#### **3.1.4 Sensor Entity** (`src/entities/sensor.entity.ts`)

**Issue 1:** Database doesn't have `created_at`, `updated_at` columns

**Required Change:**
- **File:** `src/entities/sensor.entity.ts`
- **Lines:** 51-55
- **Change:** Remove `created_at`, `updated_at` columns or mark as ignored
- **Reason:** Database schema doesn't include these columns
- **Impact:** Any code reading/writing these fields will fail

**Issue 2:** `crop_id` type mismatch

**Required Change:**
- **File:** `src/entities/sensor.entity.ts`
- **Line:** 30-31
- **Change:** Change `crop_id` from `uuid` to `varchar(36)`
- **Reason:** Database has `crop_id` as `varchar(36)`, not UUID type
- **Impact:** TypeORM may fail to map the column correctly

**Code Location:**
```typescript
// CURRENT (WRONG):
@Column({ type: 'uuid', nullable: true })
crop_id: string;  // ‚ùå DB has varchar(36), not uuid

@Column({ type: 'timestamp', precision: 6, default: () => 'CURRENT_TIMESTAMP' })
created_at: Date;  // ‚ùå Not in DB

@Column({ type: 'timestamp', precision: 6, default: () => 'CURRENT_TIMESTAMP' })
updated_at: Date;  // ‚ùå Not in DB

// REQUIRED:
@Column({ type: 'varchar', length: 36, nullable: true })
crop_id: string;  // ‚úÖ Matches DB

// Remove created_at and updated_at
```

---

#### **3.1.5 Sensor Reading Entity** (`src/entities/sensor-reading.entity.ts`)

**Issue:** Column name mismatch - Database has `createdAt` (camelCase), Backend expects `created_at` (snake_case)

**Required Change:**
- **File:** `src/entities/sensor-reading.entity.ts`
- **Line:** 28-29
- **Change:** Use `@Column({ name: 'createdAt' })` to map to database column name
- **Reason:** Database column is named `createdAt` (camelCase), not `created_at`
- **Impact:** TypeORM will fail to read/write this column without explicit mapping

**Code Location:**
```typescript
// CURRENT (WRONG):
@Column({ type: 'timestamp', precision: 6, default: () => 'CURRENT_TIMESTAMP' })
created_at: Date;  // ‚ùå DB column is "createdAt", not "created_at"

// REQUIRED:
@Column({ 
  name: 'createdAt',  // ‚úÖ Explicitly map to DB column name
  type: 'timestamp', 
  precision: 6, 
  default: () => 'CURRENT_TIMESTAMP' 
})
created_at: Date;  // Keep property name as created_at for consistency
```

**Alternative:** Rename property to `createdAt` to match database, but this requires changes throughout the codebase.

---

#### **3.1.6 Crop Entity** (`src/entities/crop.entity.ts`)

**Issue:** Primary key generation mismatch - Backend uses UUID generation, Database uses varchar(36) (not auto-generated)

**Required Change:**
- **File:** `src/entities/crop.entity.ts`
- **Line:** 6-7
- **Change:** Use `@PrimaryColumn()` instead of `@PrimaryGeneratedColumn('uuid')`
- **Reason:** Database `crop_id` is `varchar(36)` but NOT auto-generated. UUIDs must be generated in application code.
- **Impact:** TypeORM will fail to insert crops without manually setting `crop_id`

**Code Location:**
```typescript
// CURRENT (WRONG):
@PrimaryGeneratedColumn('uuid')
crop_id: string;  // ‚ùå DB doesn't auto-generate, it's just varchar(36)

// REQUIRED:
@PrimaryColumn({ type: 'varchar', length: 36 })
crop_id: string;  // ‚úÖ Must generate UUID in service code
```

**Required Service Change:** `src/modules/crops/crops.service.ts` must generate UUIDs before saving:
```typescript
import { v4 as uuidv4 } from 'uuid';

async create(createCropDto: CreateCropDto): Promise<Crop> {
  const crop = this.cropsRepository.create({
    ...createCropDto,
    crop_id: uuidv4(),  // ‚úÖ Generate UUID manually
  });
  return this.cropsRepository.save(crop);
}
```

---

### 3.2 Backend Service Changes

#### **3.2.1 Devices Service** (`src/modules/devices/devices.service.ts`)

**Issue:** Code references `created_at` which doesn't exist in database

**Required Change:**
- **File:** `src/modules/devices/devices.service.ts`
- **Lines:** 50, 103, 111 (already commented out)
- **Change:** Ensure all references to `created_at` are removed or handled gracefully
- **Reason:** Database doesn't have `created_at` column
- **Impact:** Already handled (commented out), but verify no other references exist

**Status:** ‚úÖ Already handled (commented out)

---

#### **3.2.2 Sensor Readings Service** (`src/modules/sensor-readings/sensor-readings.service.ts`)

**Issue:** Service uses `created_at` but database column is `createdAt`

**Required Change:**
- **File:** `src/modules/sensor-readings/sensor-readings.service.ts`
- **Lines:** 39, 109, 119, 135, 145, 156, 172, 186, 281
- **Change:** After fixing entity mapping, verify all queries work correctly
- **Reason:** Entity must map `created_at` property to `createdAt` column
- **Impact:** Queries using `created_at` will work once entity is fixed

**Status:** ‚ö†Ô∏è Depends on entity fix (3.1.5)

---

#### **3.2.3 Crops Service** (`src/modules/crops/crops.service.ts`)

**Issue:** Must generate `crop_id` UUIDs manually

**Required Change:**
- **File:** `src/modules/crops/crops.service.ts`
- **Change:** Ensure `create()` method generates UUID for `crop_id` before saving
- **Reason:** Database doesn't auto-generate `crop_id`, it's just varchar(36)
- **Impact:** Crop creation will fail without UUID generation

**Code Location:**
```typescript
// REQUIRED:
import { v4 as uuidv4 } from 'uuid';

async create(createCropDto: CreateCropDto): Promise<Crop> {
  const crop = this.cropsRepository.create({
    ...createCropDto,
    crop_id: createCropDto.crop_id || uuidv4(),  // ‚úÖ Generate if not provided
  });
  return this.cropsRepository.save(crop);
}
```

---

### 3.3 Backend Controller Changes

#### **3.3.1 All Controllers Using Farm Entity**

**Issue:** Controllers may return `latitude`, `longitude`, `created_at`, `updated_at` which don't exist in DB

**Required Change:**
- **Files:** All controllers that return Farm objects
- **Change:** Ensure DTOs and responses don't include non-existent fields
- **Reason:** Database doesn't have these columns
- **Impact:** API responses may include undefined/null values

**Files to Check:**
- `src/modules/farms/farms.controller.ts`
- Any controller that includes farm data in responses

---

### 3.4 Frontend Model Changes

#### **3.4.1 Farm Model** (`smart-farm-frontend/src/app/core/models/farm.model.ts`)

**Issue:** Model includes `latitude`, `longitude`, `created_at`, `updated_at` which don't exist in DB

**Required Change:**
- **File:** `smart-farm-frontend/src/app/core/models/farm.model.ts`
- **Lines:** 5-6, 8-9
- **Change:** Make these fields optional and handle gracefully if backend doesn't return them
- **Reason:** Database doesn't have these columns
- **Impact:** Frontend may receive undefined values

**Status:** ‚úÖ Already optional, but verify handling

---

#### **3.4.2 Device Model** (`smart-farm-frontend/src/app/core/models/farm.model.ts`)

**Issue:** Model includes `created_at`, `updated_at` which don't exist in DB

**Required Change:**
- **File:** `smart-farm-frontend/src/app/core/models/farm.model.ts`
- **Lines:** 26-27
- **Change:** Make these fields optional and handle gracefully
- **Reason:** Database doesn't have these columns
- **Impact:** Frontend may receive undefined values

**Status:** ‚úÖ Already optional

---

#### **3.4.3 Sensor Reading Model** (`smart-farm-frontend/src/app/core/models/farm.model.ts`)

**Issue:** Model uses `createdAt` (camelCase) which matches DB, but backend entity uses `created_at`

**Required Change:**
- **File:** `smart-farm-frontend/src/app/core/models/farm.model.ts`
- **Line:** 61
- **Change:** Verify backend returns `createdAt` or `created_at` consistently
- **Reason:** Database has `createdAt`, backend entity should map correctly
- **Impact:** Frontend may receive wrong field name

**Status:** ‚ö†Ô∏è Depends on backend entity fix (3.1.5)

---

#### **3.4.4 Action Log Model** (`smart-farm-frontend/src/app/core/models/action-log.model.ts`)

**Issue:** Model has `id: string` but database has `id: integer`

**Required Change:**
- **File:** `smart-farm-frontend/src/app/core/models/action-log.model.ts`
- **Line:** 2
- **Change:** Change `id` type to `number` or handle both string and number
- **Reason:** Database `id` is integer, not string
- **Impact:** Type mismatches in frontend

**Code Location:**
```typescript
// CURRENT (WRONG):
export interface ActionLog {
  id: string;  // ‚ùå DB has integer

// REQUIRED:
export interface ActionLog {
  id: number;  // ‚úÖ Matches DB integer
```

---

### 3.5 Frontend Service Changes

#### **3.5.1 API Service** (`smart-farm-frontend/src/app/core/services/api.service.ts`)

**Issue:** May need to handle type conversions for `action_logs.id`

**Required Change:**
- **File:** `smart-farm-frontend/src/app/core/services/api.service.ts`
- **Change:** Verify action log responses handle integer IDs correctly
- **Reason:** Database returns integer, frontend model should match
- **Impact:** Type errors if model expects string

**Status:** ‚ö†Ô∏è Depends on model fix (3.4.4)

---

### 3.6 Database Migration Considerations

#### **3.6.1 Missing Timestamp Columns**

**Decision Required:** Should `created_at` and `updated_at` be added to `farms`, `devices`, and `sensors` tables?

**Options:**
1. **Add columns to database** (recommended for audit trail)
2. **Remove from entities** (simpler, but loses audit capability)

**If adding columns:**
```sql
ALTER TABLE farms 
  ADD COLUMN created_at timestamp(6) DEFAULT CURRENT_TIMESTAMP,
  ADD COLUMN updated_at timestamp(6) DEFAULT CURRENT_TIMESTAMP;

ALTER TABLE devices 
  ADD COLUMN created_at timestamp(6) DEFAULT CURRENT_TIMESTAMP,
  ADD COLUMN updated_at timestamp(6) DEFAULT CURRENT_TIMESTAMP;

ALTER TABLE sensors 
  ADD COLUMN created_at timestamp(6) DEFAULT CURRENT_TIMESTAMP,
  ADD COLUMN updated_at timestamp(6) DEFAULT CURRENT_TIMESTAMP;
```

---

#### **3.6.2 Missing Location Columns**

**Decision Required:** Should `latitude` and `longitude` be added to `farms` table?

**Options:**
1. **Add columns to database** (enables mapping features)
2. **Remove from entity** (simpler, but loses location precision)

**If adding columns:**
```sql
ALTER TABLE farms 
  ADD COLUMN latitude numeric(10,8),
  ADD COLUMN longitude numeric(11,8);
```

---

### 3.7 Summary of Critical Changes

#### **CRITICAL (Must Fix):**
1. ‚úÖ **User Role Enum** - Change `MODERATOR` to `VIEWER`
2. ‚úÖ **Sensor Reading Column Mapping** - Map `created_at` property to `createdAt` column
3. ‚úÖ **Crop ID Generation** - Use `@PrimaryColumn()` and generate UUIDs in service
4. ‚úÖ **Action Log ID Type** - Frontend model should use `number`, not `string`

#### **HIGH PRIORITY (Should Fix):**
5. ‚ö†Ô∏è **Farm Entity** - Remove or add `latitude`, `longitude`, `created_at`, `updated_at`
6. ‚ö†Ô∏è **Device Entity** - Remove or add `created_at`, `updated_at`
7. ‚ö†Ô∏è **Sensor Entity** - Remove `created_at`, `updated_at` and fix `crop_id` type

#### **MEDIUM PRIORITY (Nice to Have):**
8. üìù **Add timestamp columns to database** (if audit trail needed)
9. üìù **Add location columns to database** (if mapping features needed)

---

## 4. TESTING CHECKLIST

After implementing changes, test:

- [ ] User creation with `viewer` role (not `moderator`)
- [ ] Farm creation/retrieval (verify no `latitude`/`longitude` errors)
- [ ] Device creation/retrieval (verify no `created_at` errors)
- [ ] Sensor creation/retrieval (verify `crop_id` works with varchar)
- [ ] Sensor reading creation/retrieval (verify `createdAt` mapping works)
- [ ] Crop creation (verify UUID generation works)
- [ ] Action log retrieval (verify integer `id` works)
- [ ] Frontend displays all data correctly
- [ ] No TypeORM errors in logs
- [ ] No undefined/null field errors

---

## 5. MIGRATION STRATEGY

### Phase 1: Entity Fixes (Backend)
1. Fix User enum
2. Fix Sensor Reading column mapping
3. Fix Crop primary key
4. Remove/add timestamp columns in entities
5. Fix Sensor crop_id type

### Phase 2: Service Fixes (Backend)
1. Add UUID generation to Crops service
2. Verify all services handle missing columns

### Phase 3: Frontend Fixes
1. Fix Action Log model ID type
2. Verify all models handle optional fields

### Phase 4: Database Migration (Optional)
1. Add timestamp columns if needed
2. Add location columns if needed

### Phase 5: Testing
1. Test all CRUD operations
2. Test frontend displays
3. Verify no errors in logs

---

**END OF REPORT**

